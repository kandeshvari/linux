net_lim control group
=====================

*Оглавление:*

- Введение
- Список параметров
- Управление портами
- Управление адресами


## Введение

todo


## Список параметров

* ipv4.addrs.allow
* ipv4.addrs.deny
* ipv4.addrs.list
* ipv4.ports.allow
* ipv4.ports.deny
* ipv4.ports.list
* ipv4.ip_local_port_range
* ipv4.default_address


## Управление портами

todo: маленькое введение


### ipv4.ports.allow
### ipv4.ports.deny
### ipv4.ports.list

Управление списком портов разрешенных для использования в системном вызове bind()

Пример:

Просмотреть список портов разрешенных для использования процессам внутри контрольной группы:
        
        # cat net_lim.ipv4.ports.list
        0-65535

_По-умолчанию_: `0-65535` - все доступные в системе

Разрешить использование всех портов в системе

        # echo "a" > net_lim.ipv4.ports.allow
или

        # echo "0-65535" > net_lim.ipv4.ports.allow

Запретить использование всех портов в системе

        # echo "a" > net_lim.ipv4.ports.deny
или
        
        # echo "0-65535" > net_lim.ipv4.ports.deny

Чтобы разрешить только отдельные порты или диапазоны портов, необходимо сначала сбросить разрешительную политику установленную по-умолчанию:

        # echo "a" > net_lim.ipv4.ports.deny

а затем добавить необходимые значения:

        # echo "2000-2100" > net_lim.ipv4.ports.allow
        # echo "14500-14501" > net_lim.ipv4.ports.allow
        # echo "10000" > net_lim.ipv4.ports.allow

Список разрешенных портов при этом будет выглядеть так:

        # cat net_lim.ipv4.ports.list
        2000-2100
        10000
        14000-14501

Обратите внимание - список диапазонов и портов отсортирован _по-возрастанию_.

Чтобы убрать диапазон портов из разрешенных:

        # echo "2000-2100" > net_lim.ipv4.ports.deny

как видно, диапазон из списка пропал:

        # cat net_lim.ipv4.ports.list
        10000
        14000-14501

Добавлять можно только тедиапазоды или порты, которые не пересекаются с уже находящимися в списке диапазонами. Удалять можно только те диапазоны, которые присутстуют в списке. Иначе возвращается ошибка `EINVAL`.

Внимание: при создании дочерней контрольной группы, значения параметров родительской группы _НЕ КОПИРУЮТСЯ_, а назначаются по-умолчанию - `0-65535`.


### ipv4.ip_local_port_range

Управление диапазоном разрешенных эфемерных портов. 

По-умолчанию, при создании контрольной группы, диапазону присваивается значение `-1`. Это указывает на то, что при выборе диапазона эфемерных портов стоит руководсвоваться значением указанным в параметре `sysctl` `net.ipv4.ip_local_port_range`. Т.к. этот параметр уникален для каждого `network namespace`, то данное значение позволяет переложить управление диапазоном на плечи `sysctl` + `net ns`

Изменить диапазон эфемерных портов:

        # echo "49000-60000" > net_lim.ipv4.ip_local_port_range

Просмотреть диапазон:

        # cat net_lim.ipv4.ip_local_port_range
        49000-60000

Отключить назначение диапазона эфемерных портов средствами контрольной группы и брать значения из параметра `sysctl` `net.ipv4.ip_local_port_range`:

        # echo "-1" > net_lim.ipv4.ip_local_port_range

Особенности:

При попытке вызвать `bind()` на порт 0, будет успользован список эфемерных портов из диапазона параметра `ipv4.ip_local_port_range`. Параметр `ipv4.ports.list` при этом применяться не будет.



### net_lim.ipv4.addrs.allow
### net_lim.ipv4.addrs.deny
### net_lim.ipv4.addrs.list

Управление списком ip адресов разрешенных для использования в системном вызове `bind()`

Просмотреть список адресов разрешенных для `bind()` процессам внутри контрольной группы:
        
        # cat net_lim.ipv4.addrs.list
        0.0.0.0

_По-умолчанию_: `0.0.0.0` - все доступные в системе

Разрешить использование всех доступных адресов в системе (разрешительная политика):

        # echo "a" > net_lim.ipv4.addrs.allow
или

        # echo "0.0.0.0" > net_lim.ipv4.addrs.allow

Запретить использование всех адресов в системе (запретительная политика):

        # echo "a" > net_lim.ipv4.addrs.deny
или
        
        # echo "0.0.0.0" > net_lim.ipv4.addrs.deny

Чтобы разрешить только отдельные ip адреса, необходимо сначала сбросить разрешительную политику установленную по-умолчанию:

        # echo "a" > net_lim.ipv4.addrs.deny

а затем добавить необходимые значения:

        # echo "127.0.0.1" > net_lim.ipv4.addrs.allow
        # echo "192.168.0.1" > net_lim.ipv4.addrs.allow
        # echo "172.16.10.1" > net_lim.ipv4.addrs.allow

Список разрешенных адресов при этом будет выглядеть так:

        # cat net_lim.ipv4.addrs.list
        127.0.0.1
        172.16.10.1
        192.168.1.1

Обратите внимание - адресов отсортирован _по-возрастанию_.

Чтобы убрать адрес из разрешенных:

        # echo "192.168.1.1" > net_lim.ipv4.addrs.deny

как видно, адрес из списка пропал:

        # cat net_lim.ipv4.addrs.list
        127.0.0.1
        172.16.10.1

Добавлять можно только те адреса, которые не присутствуют в списке. Удалять можно только те диапазоны, которые присутстуют в списке. Иначе противном случае возвращается ошибка `EINVAL`.

Внимание: при создании дочерней контрольной группы, значения параметров родительской группы _НЕ КОПИРУЮТСЯ_, а назначаются по-умолчанию - `0.0.0.0`.


### ipv4.default_address

Управление адресом, на который будет заменяться значение `0.0.0.0` при `bind()` на адрес `INADDR_ANY(0.0.0.0)` 

По-умолчанию: `0.0.0.0` - любой адрес

Изменить адрес:

        # echo "127.0.0.1" > net_lim.ipv4.default_address

Просмотреть адрес:

        # cat net_lim.ipv4.default_address

Особенности:

`ipv4.default_address` должен присутствовать в списке разрешенных адресов `ipv4.ports.list`, иначе будет выдаваться ошибка `EACCESS`.

